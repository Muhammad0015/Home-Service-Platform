<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Provider Dashboard - HomeServe</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/style.css" />
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <!-- ==================== HEADER ==================== -->
    <header class="header">
        <nav class="nav-container">
            <a href="index.html" class="logo">
                Home<span>Serve</span>
            </a>
            
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="provider-dashboard.html">Dashboard</a></li>
            </ul>
            
            <div class="nav-buttons" id="navButtons">
                <!-- Will be updated by JavaScript -->
            </div>
        </nav>
    </header>

    <!-- ==================== DASHBOARD ==================== -->
    <main class="dashboard">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1>Welcome, <span id="providerNameDisplay">Provider</span>!</h1>
                <p style="color: #6b7280;">Manage your jobs and earnings</p>
            </div>
            
            <!-- Dashboard Content -->
            <div class="dashboard-content clearfix">
                <!-- Sidebar -->
                <aside class="dashboard-sidebar">
                    <nav class="sidebar-menu">
                        <a href="#" class="active" data-tab="jobs">
                            <i class="fas fa-briefcase"></i> My Jobs
                        </a>
                        <a href="#" data-tab="reviews">
                            <i class="fas fa-star"></i> Reviews
                        </a>
                        <a href="#" data-tab="profile">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <a href="#" onclick="logout(); return false;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </nav>
                </aside>
                
                <!-- Main Content -->
                <div class="dashboard-main">
                    <!-- Stats Cards -->
                    <div class="stats-grid clearfix">
                        <div class="stat-card">
                            <div class="stat-card-inner">
                                <h3 id="totalJobs">0</h3>
                                <p>Total Jobs</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-inner">
                                <h3 id="pendingJobs">0</h3>
                                <p>Pending Requests</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-inner">
                                <h3 id="completedJobs">0</h3>
                                <p>Completed</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jobs Tab -->
                    <div id="jobsTab" class="tab-content">
                        <h2 style="margin-bottom: 20px;">Job Requests</h2>
                        
                        <div class="bookings-table-container">
                            <table class="bookings-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Customer</th>
                                        <th>Service</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center;">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="noJobs" style="display: none; text-align: center; padding: 40px;">
                            <i class="fas fa-briefcase" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3>No job requests yet</h3>
                            <p style="color: #6b7280;">You don't have any job requests at the moment.</p>
                        </div>
                    </div>
                    
                    <!-- Reviews Tab -->
                    <div id="reviewsTab" class="tab-content" style="display: none;">
                        <h2 style="margin-bottom: 20px;">Customer Reviews</h2>
                        
                        <div id="reviewsList">
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="noReviews" style="display: none; text-align: center; padding: 40px;">
                            <i class="fas fa-star" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                            <h3>No reviews yet</h3>
                            <p style="color: #6b7280;">Complete jobs to receive customer reviews.</p>
                        </div>
                    </div>
                    
                    <!-- Profile Tab -->
                    <div id="profileTab" class="tab-content" style="display: none;">
                        <h2 style="margin-bottom: 20px;">My Profile</h2>
                        
                        <div class="booking-form-container">
                            <div id="profileAlertContainer"></div>
                            
                            <form id="profileForm" novalidate="novalidate">
                                <div class="form-group">
                                    <label for="profileName">Full Name</label>
                                    <input type="text" id="profileName" name="fullName" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="profileEmail">Email Address</label>
                                    <input type="email" id="profileEmail" name="email" readonly="readonly" style="background-color: #f3f4f6;" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="profilePhone">Phone Number</label>
                                    <input type="tel" id="profilePhone" name="phone" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="profileCategory">Service Category</label>
                                    <select id="profileCategory" name="serviceCategory">
                                        <option value="1">Plumbing</option>
                                        <option value="2">Electrical</option>
                                        <option value="3">HVAC</option>
                                        <option value="4">Cleaning</option>
                                        <option value="5">Painting</option>
                                        <option value="6">Carpentry</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profileExperience">Years of Experience</label>
                                    <input type="number" id="profileExperience" name="experience" min="0" max="50" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="profileRate">Hourly Rate ($)</label>
                                    <input type="number" id="profileRate" name="hourlyRate" min="1" step="0.01" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="profileBio">Bio / Description</label>
                                    <textarea id="profileBio" name="bio" placeholder="Tell customers about yourself..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== JOB DETAILS MODAL ==================== -->
    <div class="modal-overlay" id="jobDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Job Details</h3>
                <button class="modal-close" onclick="closeJobDetailsModal()">&times;</button>
            </div>
            
            <div id="jobDetailsContent"></div>
        </div>
    </div>

    <!-- ==================== FOOTER ==================== -->
    <footer class="footer" style="margin-top: 50px;">
        <div class="footer-bottom">
            <p>&copy; 2024 HomeServe. All rights reserved.</p>
        </div>
    </footer>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/validation.js"></script>
    
    <!-- Provider Dashboard Script -->
    <script>
        /**
         * Initialize Provider Dashboard
         */
        function initProviderDashboard() {
            document.getElementById('providerNameDisplay').textContent = SessionManager.getUserName();
            
            loadProviderJobs();
            loadProviderProfile();
            loadProviderReviews();
            setupTabNavigation();
            setupProfileForm();
        }
        
        /**
         * Load provider jobs
         */
        function loadProviderJobs() {
            fetch('php/get-bookings.php?type=provider')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        displayJobs(data.data);
                        updateStats(data.data);
                    } else {
                        document.getElementById('jobsTableBody').innerHTML = '';
                        document.getElementById('noJobs').style.display = 'block';
                        document.querySelector('.bookings-table-container').style.display = 'none';
                        updateStats([]);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('jobsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading jobs</td></tr>';
                });
        }
        
        /**
         * Display jobs in table
         */
        function displayJobs(jobs) {
            const tbody = document.getElementById('jobsTableBody');
            
            document.getElementById('noJobs').style.display = 'none';
            document.querySelector('.bookings-table-container').style.display = 'block';
            
            let html = '';
            jobs.forEach(job => {
                const statusClass = 'status-' + job.status;
                const formattedDate = formatDate(job.booking_date);
                
                let actions = `<button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.85rem;" onclick="viewJobDetails(${job.booking_id})">View</button>`;
                
                if (job.status === 'pending') {
                    actions += ` <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85rem;" onclick="acceptJob(${job.booking_id})">Accept</button>`;
                    actions += ` <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85rem;" onclick="declineJob(${job.booking_id})">Decline</button>`;
                }
                
                if (job.status === 'accepted') {
                    actions += ` <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.85rem;" onclick="completeJob(${job.booking_id})">Complete</button>`;
                }
                
                html += `
                    <tr>
                        <td>#${job.booking_id}</td>
                        <td>${escapeHtml(job.customer_name) || 'N/A'}</td>
                        <td>${escapeHtml(job.category_name) || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td><span class="status ${statusClass}">${job.status.charAt(0).toUpperCase() + job.status.slice(1)}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        /**
         * Update stats
         */
        function updateStats(jobs) {
            document.getElementById('totalJobs').textContent = jobs.length;
            document.getElementById('pendingJobs').textContent = jobs.filter(j => j.status === 'pending').length;
            document.getElementById('completedJobs').textContent = jobs.filter(j => j.status === 'completed').length;
        }
        
        /**
         * Load provider profile
         */
        function loadProviderProfile() {
            fetch('php/get-profile.php?type=provider')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('profileName').value = data.data.full_name || '';
                        document.getElementById('profileEmail').value = data.data.email || '';
                        document.getElementById('profilePhone').value = data.data.phone || '';
                        document.getElementById('profileCategory').value = data.data.service_category_id || '1';
                        document.getElementById('profileExperience').value = data.data.experience_years || '';
                        document.getElementById('profileRate').value = data.data.hourly_rate || '';
                        document.getElementById('profileBio').value = data.data.bio || '';
                    }
                })
                .catch(error => console.error('Error:', error));
        }
        
        /**
         * Load provider reviews
         */
        function loadProviderReviews() {
            fetch('php/get-reviews.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        displayReviews(data.data);
                    } else {
                        document.getElementById('reviewsList').innerHTML = '';
                        document.getElementById('noReviews').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('reviewsList').innerHTML = '<p style="color: red;">Error loading reviews</p>';
                });
        }
        
        /**
         * Display reviews
         */
        function displayReviews(reviews) {
            let html = '';
            
            reviews.forEach(review => {
                const stars = generateStarRating(review.rating);
                const date = formatDate(review.created_at);
                
                html += `
                    <div class="review-card">
                        <div class="review-header">
                            <div class="review-avatar">${(review.customer_name || 'U').charAt(0).toUpperCase()}</div>
                            <div class="review-info">
                                <h4>${escapeHtml(review.customer_name) || 'Anonymous'}</h4>
                                <div class="review-rating" style="color: #f59e0b;">${stars}</div>
                            </div>
                            <div style="margin-left: auto; color: #6b7280; font-size: 0.85rem;">${date}</div>
                        </div>
                        <p class="review-text">${escapeHtml(review.comment) || 'No comment provided.'}</p>
                    </div>
                `;
            });
            
            document.getElementById('reviewsList').innerHTML = html;
            document.getElementById('noReviews').style.display = 'none';
        }
        
        /**
         * Setup tab navigation
         */
        function setupTabNavigation() {
            const tabLinks = document.querySelectorAll('.sidebar-menu a[data-tab]');
            
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    tabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                    
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).style.display = 'block';
                });
            });
        }
        
        /**
         * View job details
         */
        function viewJobDetails(jobId) {
            fetch('php/get-booking-details.php?id=' + jobId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const job = data.data;
                        const statusClass = 'status-' + job.status;
                        
                        document.getElementById('jobDetailsContent').innerHTML = `
                            <div style="margin-bottom: 15px;"><strong>Job ID:</strong> #${job.booking_id}</div>
                            <div style="margin-bottom: 15px;"><strong>Customer:</strong> ${escapeHtml(job.customer_name) || 'N/A'}</div>
                            <div style="margin-bottom: 15px;"><strong>Phone:</strong> ${escapeHtml(job.customer_phone) || 'N/A'}</div>
                            <div style="margin-bottom: 15px;"><strong>Email:</strong> ${escapeHtml(job.customer_email) || 'N/A'}</div>
                            <div style="margin-bottom: 15px;"><strong>Service:</strong> ${escapeHtml(job.category_name) || 'N/A'}</div>
                            <div style="margin-bottom: 15px;"><strong>Date:</strong> ${formatDate(job.booking_date)}</div>
                            <div style="margin-bottom: 15px;"><strong>Time:</strong> ${job.booking_time}</div>
                            <div style="margin-bottom: 15px;"><strong>Address:</strong> ${escapeHtml(job.address)}</div>
                            <div style="margin-bottom: 15px;"><strong>Description:</strong> ${escapeHtml(job.description) || 'N/A'}</div>
                            <div style="margin-bottom: 15px;"><strong>Status:</strong> <span class="status ${statusClass}">${job.status.charAt(0).toUpperCase() + job.status.slice(1)}</span></div>
                            <div style="margin-bottom: 15px;"><strong>Price:</strong> $${job.total_price}</div>
                        `;
                        
                        document.getElementById('jobDetailsModal').classList.add('active');
                    } else {
                        alert('Error loading job details');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading job details');
                });
        }
        
        /**
         * Close job details modal
         */
        function closeJobDetailsModal() {
            document.getElementById('jobDetailsModal').classList.remove('active');
        }
        
        /**
         * Accept job
         */
        function acceptJob(jobId) {
            if (confirm('Accept this job request?')) {
                updateJobStatus(jobId, 'accepted', 'Job accepted successfully!');
            }
        }
        
        /**
         * Decline job
         */
        function declineJob(jobId) {
            if (confirm('Are you sure you want to decline this job?')) {
                updateJobStatus(jobId, 'cancelled', 'Job declined.');
            }
        }
        
        /**
         * Complete job
         */
        function completeJob(jobId) {
            if (confirm('Mark this job as completed?')) {
                updateJobStatus(jobId, 'completed', 'Job marked as completed!');
            }
        }
        
        /**
         * Update job status
         */
        function updateJobStatus(jobId, status, successMessage) {
            fetch('php/update-booking.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'booking_id=' + jobId + '&status=' + status
            })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? successMessage : (data.message || 'Error updating job'));
                if (data.success) loadProviderJobs();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating job');
            });
        }
        
        /**
         * Setup profile form
         */
        function setupProfileForm() {
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                formData.append('type', 'provider');
                
                fetch('php/update-profile.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('profileAlertContainer');
                    container.innerHTML = `<div class="alert alert-${data.success ? 'success' : 'error'}">${data.success ? 'Profile updated successfully!' : data.message}</div>`;
                    
                    if (data.success) {
                        // Update session
                        const session = SessionManager.getSession();
                        session.name = document.getElementById('profileName').value;
                        SessionManager.saveSession(session);
                        
                        document.getElementById('providerNameDisplay').textContent = session.name;
                        updateNavigation();
                    }
                    
                    setTimeout(() => container.innerHTML = '', 3000);
                })
                .catch(error => console.error('Error:', error));
            });
        }
        
        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
    </script>
</body>
</html>