<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Service - HomeServe</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/style.css" />
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <!-- ==================== HEADER ==================== -->
    <header class="header">
        <nav class="nav-container">
            <a href="index.html" class="logo">
                Home<span>Serve</span>
            </a>
            
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="services.html">Services</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
            </ul>
            
            <div class="nav-buttons" id="navButtons">
                <!-- Will be updated by JavaScript -->
            </div>
        </nav>
    </header>

    <!-- ==================== BOOKING SECTION ==================== -->
    <section class="booking-section">
        <div class="booking-container">
            <h1 style="text-align: center; margin-bottom: 30px;">Book a Service</h1>
            
            <!-- Booking Steps -->
            <div class="booking-steps">
                <div class="step active" id="step1Indicator">
                    <div class="step-number">1</div>
                    <div class="step-label">Select Provider</div>
                </div>
                <div class="step" id="step2Indicator">
                    <div class="step-number">2</div>
                    <div class="step-label">Choose Date & Time</div>
                </div>
                <div class="step" id="step3Indicator">
                    <div class="step-number">3</div>
                    <div class="step-label">Confirm Booking</div>
                </div>
            </div>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Booking Form Container -->
            <div class="booking-form-container">
                <!-- Step 1: Provider Details -->
                <div id="step1" class="booking-step">
                    <h3 style="margin-bottom: 20px;">Selected Provider</h3>
                    
                    <div id="providerDetails" style="display: flex; gap: 20px; margin-bottom: 30px;">
                        <div class="spinner"></div>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-block" onclick="goToStep(2)">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <!-- Step 2: Date and Time -->
                <div id="step2" class="booking-step" style="display: none;">
                    <h3 style="margin-bottom: 20px;">Choose Date & Time</h3>
                    
                    <form id="bookingForm" novalidate="novalidate">
                        <input type="hidden" id="providerId" name="providerId" />
                        <input type="hidden" id="categoryId" name="categoryId" />
                        
                        <div class="form-group">
                            <label for="bookingDate">Preferred Date <span style="color: red;">*</span></label>
                            <input type="date" id="bookingDate" name="bookingDate" />
                            <span class="error-message" id="bookingDateError"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="bookingTime">Preferred Time <span style="color: red;">*</span></label>
                            <select id="bookingTime" name="bookingTime">
                                <option value="">Select a time</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                            </select>
                            <span class="error-message" id="bookingTimeError"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="address">Service Address <span style="color: red;">*</span></label>
                            <textarea id="address" name="address" placeholder="Enter the address where service is needed"></textarea>
                            <span class="error-message" id="addressError"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description of Work</label>
                            <textarea id="description" name="description" placeholder="Describe the work you need done..."></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-outline" onclick="goToStep(1)" style="flex: 1;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="goToStep(3)" style="flex: 1;">
                                Continue <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Step 3: Confirmation -->
                <div id="step3" class="booking-step" style="display: none;">
                    <h3 style="margin-bottom: 20px;">Confirm Your Booking</h3>
                    
                    <div id="bookingSummary" style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;"></div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-outline" onclick="goToStep(2)" style="flex: 1;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="submitBooking()" style="flex: 1;" id="confirmBtn">
                            <i class="fas fa-check"></i> Confirm Booking
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Success -->
                <div id="step4" class="booking-step" style="display: none; text-align: center;">
                    <div style="font-size: 4rem; color: #10b981; margin-bottom: 20px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Booking Confirmed!</h2>
                    <p style="color: #6b7280; margin: 20px 0;">Your booking has been submitted successfully. The service provider will contact you shortly.</p>
                    <p><strong>Booking ID:</strong> <span id="bookingId"></span></p>
                    <div style="margin-top: 30px;">
                        <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
                        <a href="services.html" class="btn btn-outline">Book Another Service</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ==================== FOOTER ==================== -->
    <footer class="footer">
        <div class="footer-bottom">
            <p>&copy; 2024 HomeServe. All rights reserved.</p>
        </div>
    </footer>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/validation.js"></script>
    
    <!-- Booking Page Script -->
    <script>
        let currentStep = 1;
        let selectedProvider = null;
        
        /**
         * Initialize Booking Page
         */
        function initBookingPage() {
            // Get provider ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const providerId = urlParams.get('provider');
            
            if (providerId) {
                loadProviderDetails(providerId);
            } else {
                window.location.href = 'services.html';
            }
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').setAttribute('min', today);
        }
        
        /**
         * Load provider details
         */
        function loadProviderDetails(providerId) {
            fetch('php/get-provider.php?id=' + providerId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selectedProvider = data.data;
                        displayProviderDetails(selectedProvider);
                        document.getElementById('providerId').value = selectedProvider.provider_id;
                        document.getElementById('categoryId').value = selectedProvider.service_category_id;
                    } else {
                        showAlert('error', 'Provider not found');
                        setTimeout(() => window.location.href = 'services.html', 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('error', 'Error loading provider details');
                });
        }
        
        /**
         * Display provider details
         */
        function displayProviderDetails(provider) {
            const stars = generateStarRating(provider.rating || 0);
            
            document.getElementById('providerDetails').innerHTML = `
                <div style="width: 100px; height: 100px; background-color: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: #6b7280;">
                    <i class="fas fa-user"></i>
                </div>
                <div style="flex: 1;">
                    <h3 style="margin-bottom: 5px;">${escapeHtml(provider.full_name)}</h3>
                    <p style="color: #2563eb; margin-bottom: 10px;">${escapeHtml(provider.category_name) || 'Service Provider'}</p>
                    <div style="color: #f59e0b; margin-bottom: 10px;">
                        ${stars} (${provider.rating || '0.0'})
                    </div>
                    <p style="color: #6b7280; font-size: 0.9rem;">${escapeHtml(provider.bio) || 'No description available.'}</p>
                    <p style="font-weight: 600; margin-top: 10px;">$${provider.hourly_rate}/hour</p>
                </div>
            `;
        }
        
        /**
         * Navigate between steps
         */
        function goToStep(step) {
            // Validate before moving forward
            if (step > currentStep) {
                if (currentStep === 2 && !validateBookingForm()) {
                    return;
                }
                if (step === 3) {
                    displayBookingSummary();
                }
            }
            
            // Hide all steps
            document.querySelectorAll('.booking-step').forEach(el => el.style.display = 'none');
            
            // Show selected step
            document.getElementById('step' + step).style.display = 'block';
            
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById('step' + i + 'Indicator');
                indicator.classList.remove('active', 'completed');
                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }
            
            currentStep = step;
        }
        
        /**
         * Validate booking form
         */
        function validateBookingForm() {
            let isValid = true;
            
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const address = document.getElementById('address').value;
            
            // Clear previous errors
            clearFieldError('bookingDate');
            clearFieldError('bookingTime');
            clearFieldError('address');
            
            if (!date) {
                showFieldError('bookingDate', 'Please select a date');
                isValid = false;
            }
            
            if (!time) {
                showFieldError('bookingTime', 'Please select a time');
                isValid = false;
            }
            
            if (!address.trim()) {
                showFieldError('address', 'Please enter the service address');
                isValid = false;
            }
            
            return isValid;
        }
        
        /**
         * Display booking summary
         */
        function displayBookingSummary() {
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const address = document.getElementById('address').value;
            const description = document.getElementById('description').value;
            
            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const timeSelect = document.getElementById('bookingTime');
            const selectedTimeText = timeSelect.options[timeSelect.selectedIndex].text;
            
            document.getElementById('bookingSummary').innerHTML = `
                <div style="margin-bottom: 15px;"><strong>Provider:</strong> ${escapeHtml(selectedProvider.full_name)}</div>
                <div style="margin-bottom: 15px;"><strong>Service:</strong> ${escapeHtml(selectedProvider.category_name) || 'Service'}</div>
                <div style="margin-bottom: 15px;"><strong>Date:</strong> ${formattedDate}</div>
                <div style="margin-bottom: 15px;"><strong>Time:</strong> ${selectedTimeText}</div>
                <div style="margin-bottom: 15px;"><strong>Address:</strong> ${escapeHtml(address)}</div>
                ${description ? `<div style="margin-bottom: 15px;"><strong>Description:</strong> ${escapeHtml(description)}</div>` : ''}
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <strong>Estimated Cost:</strong> $${selectedProvider.hourly_rate}/hour
                </div>
            `;
        }
        
        /**
         * Submit booking
         */
        function submitBooking() {
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            const formData = new FormData();
            formData.append('provider_id', document.getElementById('providerId').value);
            formData.append('category_id', document.getElementById('categoryId').value);
            formData.append('booking_date', document.getElementById('bookingDate').value);
            formData.append('booking_time', document.getElementById('bookingTime').value);
            formData.append('address', document.getElementById('address').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('total_price', selectedProvider.hourly_rate);
            
            fetch('php/book-service.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('bookingId').textContent = '#' + data.data.booking_id;
                    
                    // Show success step
                    document.querySelectorAll('.booking-step').forEach(el => el.style.display = 'none');
                    document.getElementById('step4').style.display = 'block';
                    
                    // Mark all steps as completed
                    for (let i = 1; i <= 3; i++) {
                        document.getElementById('step' + i + 'Indicator').classList.add('completed');
                        document.getElementById('step' + i + 'Indicator').classList.remove('active');
                    }
                } else {
                    showAlert('error', data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check"></i> Confirm Booking';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', 'An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Confirm Booking';
            });
        }
        
        // Make functions globally available
        window.goToStep = goToStep;
        window.submitBooking = submitBooking;
    </script>
</body>
</html>